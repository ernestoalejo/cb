package v0

import (
	"fmt"
	"strings"
)

type Field interface {
	Build(form *Form) string
}

type Form struct {
	// The original data file of this form
	Filename string

	// Name of the controller of the form
	Name string

	// Javascript function called when the form passed all the validations
	// and is sent. Without the () pair
	Submit string

	// Javascript function called each time the user try to send the form
	// Without the () pair
	TrySubmit string

	// Name of the client side object that will be scoped
	// with the values of the form
	ObjName string

	Fields      []Field
	Validators map[string][]*Validator
}

func (f *Form) Build() string {
	results := []string{}
	for _, field := range f.Fields {
		results = append(results, field.Build(f))
	}
	return fmt.Sprintf(`
    <!-- AUTOGENERATED BY cb FROM %s, PLEASE, DON'T MODIFY IT -->
    <form class="form-horizontal" name="%s" novalidate ng-init="%s.val = false;"
        ng-submit="%s.$valid && %s()"><fieldset>%s</fieldset></form>
  `, f.Filename, f.Name, f.Name, f.Name, f.Submit, strings.Join(results, ""))
}

// ==================================================================

func buildControl(form *Form, id, name, help string) (map[string]string, string) {
	var errs, messages string
	attrs := map[string]string{}

	fid := fmt.Sprintf("%s%s", form.Name, id)
	messages = fmt.Sprintf("\n" + `<p class="help-block error" `+
		`ng-show="%s.val && %s.%s.$invalid">`, form.Name, form.Name, fid)

	for _, val := range form.Validators[id] {
		update(attrs, val.Attrs)
		errs += fmt.Sprintf("%s.%s.$error.%s || ", form.Name, fid, val.Error)
		messages += fmt.Sprintf(`<span ng-show="%s.%s.$error.%s">%s</span>` + "\n",
			form.Name, fid, val.Error, val.Message)
	}

	messages += "</p>\n"
	if len(errs) > 0 {
    errs = fmt.Sprintf("(%s)", errs[:len(errs)-4])
  } else {
    errs = "false"
  }

  if name == "" {
		return attrs, fmt.Sprintf(`
      <div class="control-group" ng-class="%s.val && %s && 'error'">
        %%s%s
      </div>
    `, form.Name, errs, messages)
	}

	return attrs, fmt.Sprintf(`
    <div class="control-group" ng-class="%s.val && %s && 'error'">
      <label class="control-label" for="%s">%s</label>
      <div class="controls">%%s%s</div>
    </div>
  `, form.Name, errs, fid, name, messages)
}

// ==================================================================

type InputField struct {
	Id, Name    string
	Help        string
	Type        string
	Class       []string
	PlaceHolder string

	Attrs map[string]string
}

func (f *InputField) Build(form *Form) string {
	if f.Type == "" {
		panic("input type should not be empty: " + f.Id)
	}

	attrs := map[string]string{
		"type":        f.Type,
		"id":          fmt.Sprintf("%s%s", form.Name, f.Id),
		"name":        fmt.Sprintf("%s%s", form.Name, f.Id),
		"placeholder": f.PlaceHolder,
		"class":       strings.Join(f.Class, " "),
		"ng-model":    fmt.Sprintf("%s.%s", form.ObjName, f.Id),
	}
	update(attrs, f.Attrs)

	controlAttrs, control := buildControl(form, f.Id, f.Name, f.Help)
	update(attrs, controlAttrs)

	ctrl := "<input"
	for k, v := range attrs {
		ctrl += fmt.Sprintf(` %s="%s"`, k, v)
	}
	ctrl += ">"

	return fmt.Sprintf(control, ctrl)
}

// ==================================================================

type SubmitField struct {
	Label       string
	CancelUrl   string
	CancelLabel string
}

func (f *SubmitField) Build(form *Form) string {
	cancel := ""
	if f.CancelLabel != "" && f.CancelUrl != "" {
		cancel = fmt.Sprintf(`&nbsp;&nbsp;&nbsp;<a href="%s" class="btn">%s</a>`,
			f.CancelUrl, f.CancelLabel)
	}

	return fmt.Sprintf(`
    <div class="form-actions">
      <button ng-click="%s(); %s.val = true;" class="btn btn-primary"
        ng-disabled="%s.val && !%s.$valid">%s</button>
      %s
    </div>
  `, form.TrySubmit, form.Name, form.Name, form.Name, f.Label, cancel)
}

// ==================================================================

type TextAreaField struct {
	Id, Name    string
	Help        string
	Class       []string
	Rows        int
	PlaceHolder string
}

func (f *TextAreaField) Build(form *Form) string {
	attrs := map[string]string{
		"id":          fmt.Sprintf("%s%s", form.Name, f.Id),
		"name":        fmt.Sprintf("%s%s", form.Name, f.Id),
		"placeholder": f.PlaceHolder,
		"class":       strings.Join(f.Class, " "),
		"ng-model":    fmt.Sprintf("%s.%s", form.ObjName, f.Id),
		"rows":        fmt.Sprintf("%d", f.Rows),
	}

	controlAttrs, control := buildControl(form, f.Id, f.Name, f.Help)
	update(attrs, controlAttrs)

	ctrl := "<textarea"
	for k, v := range attrs {
		ctrl += fmt.Sprintf(` %s="%s"`, k, v)
	}
	ctrl += "></textarea>"

	return fmt.Sprintf(control, ctrl)
}

// ==================================================================

type RadioBtnField struct {
  Id, Name    string
  Help        string
  Values map[string]string
}

func (f *RadioBtnField) Build(form *Form) string {
  _, control := buildControl(form, f.Id, f.Name, f.Help)
  model := fmt.Sprintf("%s.%s", form.ObjName, f.Id)

  ctrl := `<div class="btn-group">`
  for k, v := range f.Values {
    ctrl += fmt.Sprintf(`<button type="button" class="btn btn-primary" ` +
      `ng-model="%s" btn-radio="'%s'">%s</button>`, model, k, v)
  }
  ctrl += "</div>"

  return fmt.Sprintf(control, ctrl)
}

// ==================================================================

type DateField struct {
  Id, Name    string
  Help        string
  Values map[string]string
  DateOptions string
  Class []string
}

func (f *DateField) Build(form *Form) string {
  attrs := map[string]string{
    "type":        "text",
    "id":          fmt.Sprintf("%s%s", form.Name, f.Id),
    "name":        fmt.Sprintf("%s%s", form.Name, f.Id),
    "class":       strings.Join(f.Class, " "),
    "ng-model":    fmt.Sprintf("%s.%s", form.ObjName, f.Id),
    "bs-date": f.DateOptions,
  }

  controlAttrs, control := buildControl(form, f.Id, f.Name, f.Help)
  update(attrs, controlAttrs)

  ctrl := "<input readonly"
  for k, v := range attrs {
    ctrl += fmt.Sprintf(` %s="%s"`, k, v)
  }
  ctrl += ">"

  ctrl = fmt.Sprintf(`
    <div class="input-append date">
      %s
      <span class="add-on"><i class="icon-calendar"></i></span>
    </div>
  `, ctrl)

  return fmt.Sprintf(control, ctrl)
}

// ==================================================================

type SelectField struct {
  Id, Name    string
  Help        string
  Origin, OriginId, OriginLabel string
  Class []string
}

func (f *SelectField) Build(form *Form) string {
  attrs := map[string]string{
    "id":          fmt.Sprintf("%s%s", form.Name, f.Id),
    "name":        fmt.Sprintf("%s%s", form.Name, f.Id),
    "class":       strings.Join(f.Class, " "),
    "ng-model":    fmt.Sprintf("%s.%s", form.ObjName, f.Id),
  }

  controlAttrs, control := buildControl(form, f.Id, f.Name, f.Help)
  update(attrs, controlAttrs)

  ctrl := "<select"
  for k, v := range attrs {
    ctrl += fmt.Sprintf(` %s="%s"`, k, v)
  }
  ctrl += fmt.Sprintf(` ng-options="item.%s as item.%s for item in %s"></select>`,
      f.OriginId, f.OriginLabel, f.Origin)

  return fmt.Sprintf(control, ctrl)
}

// ==================================================================

type CheckboxField struct {
  Id, Name    string
  Help        string
}

func (f *CheckboxField) Build(form *Form) string {
  attrs := map[string]string{
    "type":        "checkbox",
    "id":          fmt.Sprintf("%s%s", form.Name, f.Id),
    "name":        fmt.Sprintf("%s%s", form.Name, f.Id),
    "ng-model":    fmt.Sprintf("%s.%s", form.ObjName, f.Id),
  }

  ctrl := "<input"
  for k, v := range attrs {
    ctrl += fmt.Sprintf(` %s="%s"`, k, v)
  }
  ctrl += ">"

  return fmt.Sprintf(`
    <div class="control-group"><div class="controls">
      <label class="checkbox">
        %s %s
      </label>
    </div></div>
  `, ctrl, f.Name)
}

